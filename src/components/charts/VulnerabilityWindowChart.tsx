import { Bar, BarChart, CartesianGrid, ResponsiveContainer, Tooltip, XAxis, YAxis } from 'recharts';
import { VulnerabilityWindowDatum } from '../../utils/vulnerability';

interface VulnerabilityWindowChartProps {
  data: VulnerabilityWindowDatum[];
  highestWindow: VulnerabilityWindowDatum | null;
}

export function VulnerabilityWindowChart({ data, highestWindow }: VulnerabilityWindowChartProps) {
  return (
    <div className="rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
      <h3 className="text-sm font-semibold text-gray-800">Post-Discharge Vulnerability Window</h3>
      <p className="mt-1 text-xs text-gray-500">Average recovery priority score by days since discharge</p>

      <div className="mt-4 h-72">
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={data}>
            <CartesianGrid stroke="#e5e7eb" strokeDasharray="3 3" />
            <XAxis dataKey="window" tick={{ fill: '#6B7280', fontSize: 11 }} />
            <YAxis domain={[0, 100]} allowDecimals={false} tick={{ fill: '#6B7280', fontSize: 11 }} />
            <Tooltip
              formatter={(value: number, key: string, payload: { payload?: VulnerabilityWindowDatum }) => {
                if (key === 'avgRisk') {
                  const riskValue = payload.payload?.count === 0 ? '—' : `${Math.round(value)}`;
                  return [riskValue, 'Avg priority score'];
                }
                return [Math.round(value), key];
              }}
              labelFormatter={(label: string) => `Window: ${label}`}
            />
            <Bar dataKey="avgRisk" fill="#2563EB" radius={[6, 6, 0, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </div>

      <div className="mt-3 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
        {highestWindow
          ? `Highest vulnerability window: ${highestWindow.window} (${Math.round(highestWindow.avgRisk)} avg priority score, n=${Math.round(highestWindow.count)})`
          : 'Highest vulnerability window: —'}
      </div>
    </div>
  );
}
