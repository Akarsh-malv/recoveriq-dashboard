import { SeedPatient } from '../mocks/seedPatients';

export type VulnerabilityWindowLabel = 'D+0-7' | 'D+8-14' | 'D+15-30' | 'D+31+';

export interface VulnerabilityWindowDatum {
  window: VulnerabilityWindowLabel;
  avgRisk: number;
  count: number;
}

interface WindowAccumulator {
  window: VulnerabilityWindowLabel;
  min: number;
  max: number | null;
  sumRisk: number;
  count: number;
}

const DAY_MS = 1000 * 60 * 60 * 24;

const windowAccumulators: WindowAccumulator[] = [
  { window: 'D+0-7', min: 0, max: 7, sumRisk: 0, count: 0 },
  { window: 'D+8-14', min: 8, max: 14, sumRisk: 0, count: 0 },
  { window: 'D+15-30', min: 15, max: 30, sumRisk: 0, count: 0 },
  { window: 'D+31+', min: 31, max: null, sumRisk: 0, count: 0 },
];

function getDaysSinceDischarge(dischargeDate: string): number {
  const discharge = new Date(dischargeDate).getTime();
  const today = Date.now();
  return Math.max(0, Math.floor((today - discharge) / DAY_MS));
}

function findWindow(days: number): WindowAccumulator {
  return (
    windowAccumulators.find((bucket) => {
      if (bucket.max === null) {
        return days >= bucket.min;
      }
      return days >= bucket.min && days <= bucket.max;
    }) ?? windowAccumulators[windowAccumulators.length - 1]
  );
}

export function getVulnerabilityWindowData(patients: SeedPatient[]): VulnerabilityWindowDatum[] {
  const buckets = windowAccumulators.map((bucket) => ({
    ...bucket,
    sumRisk: 0,
    count: 0,
  }));

  patients.forEach((patient) => {
    const days = getDaysSinceDischarge(patient.dischargeDate);
    const bucket = buckets.find((candidate) => candidate.window === findWindow(days).window);
    if (!bucket) {
      return;
    }

    bucket.sumRisk += patient.riskScore;
    bucket.count += 1;
  });

  return buckets.map((bucket) => ({
    window: bucket.window,
    avgRisk: bucket.count === 0 ? 0 : Math.round(bucket.sumRisk / bucket.count),
    count: Math.round(bucket.count),
  }));
}

export function getHighestVulnerabilityWindow(data: VulnerabilityWindowDatum[]): VulnerabilityWindowDatum | null {
  const nonEmpty = data.filter((bucket) => bucket.count > 0);
  if (nonEmpty.length === 0) {
    return null;
  }

  return nonEmpty.reduce((highest, current) => (current.avgRisk > highest.avgRisk ? current : highest));
}
